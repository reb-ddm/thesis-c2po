\section{Restriction to a subset of terms}

\todo[inline]{Change it to a positive set instead of a negative set.}

During an assignment, it is necessary to forget information about a specific set of terms.
For instance, when assigning a value to a term, all terms in the domain that might be modified by this assignment---those that may alias with this term---must be removed.
This section explains how to restrict a kernel $k = \angl{P, M_P, B, D}$
to exclude all propositions containing terms from a specified set.

We begin by defining the restriction of a partition $P = (\T, \tau, \omega)$ and its corresponding automaton $M_P = (S, \otau, \eta, \delta)$ to forget information about the terms in a set $\Set$.
The complement of $\Set$ needs to be closed under subterms, ensuring that the
resulting partition will still contain terms from a set that remains closed under subterms.

Given a set $\Set$, we can find a restricted
automaton $\restr{M_P}{-\Set} = (S', \otau', \eta', \delta')$ such that $\L(\restr{M_P}{-\Set})$ does not include terms from
$\Set$, but retains the equalities between all other terms in $\L(M_P) \setminus \Set$.
From this, we derive the restricted partition $\restr{P}{-\Set} = (\T', \tau', \omega')$, where $\T'$ contains
the terms in $\T \setminus \Set$ and additionally all terms that appear in the codomain of the function $\otau'$.

This is necessary to ensure that for each state $s \in S'$, a representative term in $\T'$ can be found,
even if $\T \setminus \Set$ does not contain any term in $\L_{\restr{M_P}{-\Set}}(s)$.

\begin{example}
    Consider the conjunction $\Psi \equiv \&x = \&z \land *x = \&y$.
    We choose $\T = \{\&x, \&y, \&z, x, *x\}$. The corresponding automaton $M_P$ can be visualized as follows:

    \begin{center}
        \begin{tikzpicture}[shorten >=1pt, node distance=3cm, on grid, auto,
                state/.style={rectangle, rounded corners, draw, inner sep=3pt, align=center}]
            \node[state] (q_0) {$\&x, \&z$};
            \node[below=0.5cm of q_0] {$s_1$};
            \node[state] (q_1) [right=of q_0] {$x$};
            \node[below=0.5cm of q_1] {$s_2$};
            \node[state] (q_2) [right=of q_1] {$*x, \&y$};
            \node[below=0.5cm of q_2] {$s_3$}; % Label for the third state

            \path[->]
            (q_0) edge node {} (q_1)
            (q_1) edge node {} (q_2);
        \end{tikzpicture}
    \end{center}
    Let $\Set$ be the set of terms that contain the variable $x$.
    If we simply remove all terms from $\Set$ from the automaton, the state $s_2$ would
    not contain any terms from $\T \setminus \Set$.
    However, the set $\L_{M_P}(s_2)$ contains not only $x$, but also $z$, which is not in $\Set$.
    Therefore, we can choose $z$ as the new representative for $s_2$.
    The new set of terms after the restriction is $\T' = (\T \setminus \Set) \cup \{z\} = \{\&y, \&z, z\}$.
    The resulting automaton can be visualized as follows:
    \begin{center}
        \begin{tikzpicture}[shorten >=1pt, node distance=3cm, on grid, auto,
                state/.style={rectangle, rounded corners, draw, inner sep=3pt, align=center}]
            \node[state] (q_0) {$\&z$};
            \node[below=0.5cm of q_0] {$s_1$};
            \node[state] (q_1) [right=of q_0] {$z$};
            \node[below=0.5cm of q_1] {$s_2$};
            \node[state] (q_2) [right=of q_1] {$\&y$};
            \node[below=0.5cm of q_2] {$s_3$};

            \path[->]
            (q_0) edge node {} (q_1)
            (q_1) edge node {} (q_2);
        \end{tikzpicture}
    \end{center}
    It represents the formula $*z = \&y$.
    \todo{add edge weights}
\end{example}

The restriction $\restr{M_P}{-\Set} = (S', \otau', \eta', \delta')$ is computed using a breadth-first search (BFS) on the automaton $M_P$
to determine which paths remain reachable after excluding all terms in $\Set$.
For some states $s \in S$, the representative $\otau(s)$ might be in $\Set$.
If this is the case, we need to find a new representative for $s$ from the set $\L_{M_P}(s) \setminus \Set$.
If this set is empty, the state $s$ must be removed from the automaton.

The algorithm proceeds as follows, with $\V$ representing the set of visited states and $Q$ being a queue of states to be processed:
\begin{enumerate}
\item Start with the initial states of $M_P$ and consider each atom $a \in \T \setminus \Set$ where $\eta(a) = (z, s)$:
   \begin{itemize}
       \item If $s$ has not been visited, choose a new representative for $s$.
       Set $\otau'(s) = a$ and $\eta'(a) = (0, s)$.
       Add $s$ to $\V$ and to $Q$.
       \item If $s$ has already been visited, there exists a $t$ such that $\otau'(s) = t$.
       Let $M_P[t] = (z', s)$.
       Define $\eta'(a) = (z - z', s)$.
   \end{itemize}

\item Remove a state $s_1$ from the queue $Q$.
Consider all outgoing transitions $\delta(z_1, s_1) = (z_2, s_2)$.
   \begin{itemize}
       \item If a term $*(z+t) \in \L(M) \setminus \Set$ can be found such that $M_P[t] = (z_1', s_1)$ and $z = z_1 - z_1'$,
       the transition remains valid.
           \begin{itemize}
               \item If $s_2$ has not been visited, set $\otau'(s_2) = *(z+t)$ and add $s_2$ to $\V$ and to $Q$.
               \item If $s_2$ has been visited, $\otau'(s_2)$ is already defined.
               \item Let $M_P[\otau'(s_1)] = (z_3, s_1)$ and $M_P[\otau'(s_2)] = (z_4, s_2)$.
               Define the corresponding transition $\delta'(z_1 - z_3, s_1) = (z_2 - z_4, s_2)$.
           \end{itemize}
       \item If no such term is found, the transition is no longer valid in $\restr{M_P}{-\Set}$, and $s_2$ is not added to the set of visited states.
   \end{itemize}
\item If $Q$ is not empty, return to step 2 and continue processing.
\end{enumerate}

Essentially, the algorithm retains the transitions between the states that remain reachable after removing the terms and adjusts the weights of these transitions to the new representatives.
The set $S'$ is equivalent to the set of visited states $\V$.

The new partition $\restr{P}{-\Set} = (\T', \tau', \omega')$ is defined as follows:
\begin{itemize}
    \item $\T' = (\T \setminus \Set) \cup \{t \mid \exists s \in S' . \otau'\,s = t\}$,
    \item For each $t \in \T'$, if $\restr{M_P}{-\Set}[t] = (z, s)$, then $\tau'\,t = \otau'\,s$ and $\omega'\,t = z$.
\end{itemize}

\begin{theorem}\label{restriction}
    Let $M_P = (S, \otau, \eta, \delta)$ be a QFA and let $\restr{M_P}{-\Set} = (S', \otau', \eta', \delta')$ be the automaton that is obtained by restricting $M_P$ as described above.
    Then,
    \begin{enumerate}
        \item\label{item:lemma-restriction} for each term $t \in \L(\restr{M_P}{-\Set})$, it holds that $M_P[t] = (z, s)$ and $M_P[\otau'\,s] = (z', s')$ iff $\restr{M_P}{-\Set}[t] = (z - z', s)$ and $s = s'$,
        \item $\L(\restr{M_P}{-\Set}) = \L(M_P) \setminus \Set$ and
              \item\label{item:correctness-restriction} for each term $t_1, t_2 \in \L(\restr{M_P}{-\Set})$, it holds that $M_P[t_1] = z + M_P[t_2]$ iff $\restr{M_P}{-\Set}[t_1] = z + \restr{M_P}{-\Set}[t_2]$.
    \end{enumerate}
\end{theorem}
\begin{proof}
    The first point can be proven by induction over the structure of the term $t$.
    \todo[inline]{Proof of point 2}
    Point~\labelcref{item:correctness-restriction} follows from point~\labelcref{item:lemma-restriction}.
\end{proof}
%--------------
\subsubsection{(Block-)Disequalities}
We can also find the set of disequalities and the block disequalities that are still valid when considering only the terms $\T'$.
We keep only the propositions between representatives of the equivalence classes that
still have a corresponding state in the automaton $\restr{M_P}{-\Set}$, but we need to update the representatives to the new representatives.
The remaining disequalities are removed.

For $k = \bot$, the restriction $\restr{k}{-\Set}$ is also $\bot$.

Given a conjunction $\Psi$, we denote the restriction of the corresponding kernel $k$ to forget propostions about terms in $\Set$ by $\restr{\Psi}{-\Set}$.\todo{do you need this in the end?}
