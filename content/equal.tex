\section{Equality}

Given two kernels $k_1$ and $k_2$, we want to decide whether they are semantically equivalent.
In this section, two methods for computing the \emph{equal} operation are presented.
Their main difference is in how the equivalence of two partitions $P_1$ and $P_2$ is decided.
The first method is based on comparing the equivalence classes of the partitions $P_1$ and $P_2$.
The second method is based on computing a normal form of the conjunctions represented by the kernels $k_1$ and $k_2$.
It then suffices to compare the normal forms syntactically. This has the advantage that the normal form can be computed once
for every kernel and there is no need to recompute it for every comparison.

\subsection{Comparing Equivalence Classes}

Let $P_1 = (\T_1, \tau_1, \omega_1)$ and $P_2 = (\T_2, \tau_2, \omega_2)$ be two partitions.
First, we extend both partitions to the set $\T = \T_1 \cup \T_2$.
Then we compare the equivalence classes of the resulting partitions $P_1' = (\T, \tau_1', \omega_1')$ and $P_2' = (\T, \tau_2', \omega_2')$ of $\ext{P_1}{\T}$ and $\ext{P_2}{\T}$.

For this, we need to check for each element $t \in \T$, if $t = \omega_1'\,t + \tau_1'\,t$ also holds in $P_2$, i.e.,
if $\omega_2'\,t + \tau_2'\,t = \omega_1'\,t + \omega_2'\,(\tau_1'\,t) + \tau_2'\,(\tau_1'\,t)$.

Afterwards, the disequalities and block disequalities are compared.
For two kernels $k_1 = \angl{P_1, M_{P_1}, B_1, D_1}$ and $k_2 = \angl{P_2, M_{P_2}, B_2, D_2}$,
we rewrite the disequalities $B_2$ and $D_2$ to be about the representatives of $P_1$.
I.e., for each disequality $t_1 \neq z + t_2$ in $D_2$, we convert it to the disequality $\tau_1'\,t_1 \neq (z + \omega_1'\,t_2 - \omega_1'\,t_1) + \tau_1'\,t_2$
and for each block disequality $bl(t_1) \neq bl(t_2)$ in $B_2$, we convert it to the disequality $bl(\tau_1'\,t_1) \neq bl(\tau_1'\,t_2)$.
This is possible, because we previously extended the partitions to the same set $\T$,
i.e., $\tau_1'\,t$ is defined for each term $t$ occurring in $B_2$ and $D_2$.
Then we check if the resulting set of block disequalities is equal to $B_1$ and if the resulting set of disequalities is equal to $D_1$.

\subsection{Compute Normal Form}

In~\cite{2pointer} a different approach is presented to decide the equivalence of two partitions.
This is done by computing a normal form $\nf(\Psi)$ of a conjunction $\Psi$, such that $\Psi$ is semantically equivalent to $\nf(\Psi)$ and such that two conjunctions $\Psi_1$ and $\Psi_2$ are semantically equivalent iff $\nf(\Psi_1)$ and $\nf(\Psi_2)$ are syntactically equivalent.

The main idea is to find \emph{minimal representatives} for each state $s$ in the QFA $M_P$,
which corresponds to the smallest term in $\L_{M_P}(s)$, according to the order defined in \cref{chapter:2pointer}.
Then the automaton is transformed to a formula that utilizes only the minimal representatives, thus obtaining a normal form
that is independent on the chosen set $\T$ and on the chosen representatives.

Let $M_P = (S, \otau, \eta, \delta)$ be a QFA.\@
For each state $s \in S$, we compute the minimal term $m_s$ and the corresponding offset $z_s$ such that $M[m_s] = (z_s,s)$.
This can be computed by using a variantion of Dijktra's shortest path algorithm,
that will be described in the following.
We use an initially empty FIFO queue $P$ to store all states $s$ for which $(m_s,z_s)$ is already computed,
but where the outgoing edges still have to be processed.
First, we consider all atoms $a$ for which $\eta$ is defined, in ascending order. For each $\eta\,a = (z,s)$ we do:
\begin{enumerate}
    \item If $(m_s,z_s)$ is not defined yet, set $(m_s,z_s) = (a,z)$.
    \item Add $s$ to $P$.
\end{enumerate}
Then we process the queue $P$ in a FIFO manner, until it is empty.
For each state $s$ in $P$, we consider all outgoing edges $\delta\,z\,s = (z',s')$ in order of ascending $z$.
For each such edge, we do:
\begin{enumerate}
    \item If $(m_{s'},z_{s'})$ is not defined yet, set $(m_{s'},z_{s'}) = (*((z-z_s)+m_s),z')$.
    \item Add $s'$ to $P$.
\end{enumerate}
The algorithm is correct because longer paths always result in larger terms than shorter paths.
Thus, we do not need to update a pair once it was computed.

\begin{example}\label{ex:min-repr}
    Let $\Psi \equiv B = -1 + \&x \land *B = 2 + A \land *A = 3 + x$.
    The automaton $M_P$\todo{what is P} has can be visualized with the following graph:
    \begin{center}
        \begin{tikzpicture}[shorten >=1pt, node distance=3cm, on grid, auto, state/.style={rectangle, rounded corners, draw, inner sep=5pt, align=center}]

            \node[state] (Q1) {$\begin{array}{c}
                        \boldsymbol{\&x}, \\
                        1 + B
                    \end{array}$};

            \node[state, right=4.5cm of Q1] (Q2) {$\begin{array}{c}
                        \boldsymbol{*B}, 2 + A, \\
                        *(-1+\&x )
                    \end{array}$};

            \node[state, right=5.6cm of Q2] (Q3) {$\begin{array}{c}
                        \boldsymbol{x}, *(1 + B), -3 + *A, \\
                        -3 + *(-2+*B),...
                    \end{array}$};

            \path[->]
            (Q1) edge[] node {$-1,0$} (Q2)
            (Q2) edge[] node {$-2,3$} (Q3)
            (Q1) edge[bend right] node {$0,0$} (Q3);

            \node [above left=1cm and 0.3cm of Q1] {$s_0$};
            \node [above left=1cm and 0.5cm of Q2] {$s_1$};
            \node [above left=1cm and 0.7cm of Q3] {$s_2$};

        \end{tikzpicture}
    \end{center}
    The minimal representatives are computed by first considering the atoms in ascending order.
    Assuming that the linear order on atoms is $\&x < A < B$,
    we define first $m_{s_0} = \&x$ and $z_{s_0} = 0$.
    Then we define $m_{s_1} = A$ and $z_{s_1} = -2$.
    There is nothing to do for $B$, because we already defined $m_{s_0}$.
    The queue $P$ is now $\{s_0, s_1\}$.
    We consider the outgoing edge of $s_0$ with $z = -1$.
    There is nothing to do for $s_1$, as $m_{s_1}$ is already defined.
    Then we consider the outgoing edge of $s_0$ with $z = 0$
    and set $m_{s_2} = x$ and $z_{s_2} = 0$.
    Then we are done.
\end{example}
Using the minimal representatives, we can now transform the kernel $k = \angl{P,M_P,B,D} \neq \bot$ with $M_P = (S, \otau, \eta, \delta)$ to a normal formula $\F_{normal}[k]$,
defined as follows:

\[
    \begin{array}{lll}
        \F_{normal}[k] & \equiv & \bigwedge_{\eta\,a=(z,s)} (a = (z - z_s) + m_s) \land                                                           \\
                         &        & \bigwedge_{\delta\,z\,s=(z',s')} (*((z-z_s) + m_s) = (z'-z_{s'} + m_{s'}) \land                                 \\
                         &        & \bigwedge_{s,s' \in S \land \{\otau\,s, \otau\,s'\} \in B} (bl(m_{s}) \neq bl(m_{s'})) \land           \\
                         &        & \bigwedge_{s,s' \in S \land (\otau\,s, z,\otau\,s') \in D} (m_{s} \neq (z+ z_{s} -z_{s'}) + m_{s'})
    \end{array}
\]

The trivial propositions of the form $t = 0 + t$ are removed from the formula, as well as the repeated equalities.

This corresponds to the formula representation $\F[k]$, but it expresses the proposition using the minimal representatives instead of the representatives of the union-find.
The advantage of this normal form is that the formula representation does not depend on the chosen representatives and also not of the chosen set $\T$.
Thus, there is a unique normal form for each semantic equivalence class of kernels,
even though there exists multiple different kernel representations of the same conjunction.
Therefore, in order to decide the equivalence of two kernels $k_1$ and $k_2$, it suffices to compare the normal forms $\F_{normal}[k_1]$ and $\F_{normal}[k_2]$ syntactically.

\begin{example}
    Consider the conjunction $\Psi$ from \cref{ex:min-repr}.
    The normal form of the kernel $k$ representing $\Psi$ is
    \[
    (B = -1+\&x) \land (*(-1 + \&x) = 2 + A) \land (*A = 3 + x)
    \]
    where $B = -1 + \&x$ originates from $\eta\,B = (-1,s_0)$.
    The equalities originating from $\eta\,\&x = (0,s_0)$ and $\eta\,A = (0, s_1)$ are removed, because they are trivial.
    The edge $\delta\,(-1,s_0) = (0,s_0)$ gives the equality $*(-1 + \&x) = 2 + A$ and
    $\delta\,(-2,s_1) = (3,s_2)$ gives the equality $*A = 3 + x$.
    The last edge $\delta\,(0,s_0) = (0,s_2)$ gives the trivial equality $x = 0 + x$.
\end{example}

\todo[inline]{Correctness proof}

\todo[inline]{Proof that they are equivalent}

\todo[inline]{Implementation detail: it is lazily computed.}
\subsection{Partial Order}

The natural partial ordering between conjunctions is semantic implication, i.e.,
$\Psi_1 \rightarrow \Psi_2$
iff $(\rho, \nu, \mu) \models \Psi_1$ whenever $(\rho, \nu, \mu) \models \Psi_2$.
This is the case iff $\Psi_1 \land \Psi_2$ is semantically equal to $\Psi_1$.
Therefore it is possible to reduce the \emph{less equal} operation to a \emph{meet} and an \emph{equal} operation.
A kernel $k_1$ that represents a conjunction $\Psi_1$ is \emph{less or equal} to a kernel $k_2$ representing $\Psi_2$ iff
$k_1 \meet k_2$ is semantically equal to $k_1$.
We already described how to decide semantic equality between two kernels.
In the next section, the \emph{meet} operation ($\meet$) is presented.
