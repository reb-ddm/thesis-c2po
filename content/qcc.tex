\section{Quantitative congruence closure}\label{chapter:qcc}

Given a conjunction $\Psi$ of propositions, the quantitative congruence closure infers all equalities that are logically implied by $\Psi$.
As there are infinitely many such equalities, we consider only the equalities that contain terms from a specific set $\T$ of terms.
The set $\T$ must be subterm-closed and contain at least all the terms that occur in $\Psi$.
The equalities implied by $\Psi$ are described by the quantitative equivalence relation $\equivp$,
which is the smallest equivalence relation $\equivp$ that satisfies these rules:
\begin{enumerate}[label={[E\arabic*]}, ref={[E\arabic*]}]
  \setcounter{enumi}{-1}
\item\label{item:persistence} If $t_1 = z+t_2$ occurs in $\Psi$, then $t_1 \equivp z+t_2$;
\item\label{item:quantitative-reflexivity} $t_1 \equivp 0+t_1$ for all $t\in\T$ (\emph{quantitative reflexivity});
\item\label{item:quantitative-symmetry} If $t_1 \equivp z+t_2$, then $t_2 \equivp -z+t_1$ (\emph{quantitative symmetry});
\item\label{item:quantitative-transitivity} If $t_1 \equivp z_1+t_2$ and $t_2 \equivp z_2 + t_3$,
		then $t_1 \equivp (z_1+z_2)+t_3$ (\emph{quantitative transitivity});
\item\label{item:dereferencing} If $t_1 \equivp (z_2 - z_1) + t_2$, then $*(z_1 + t_1) \equivp *(z_2 + t_2)$ holds as well, whenever $*(z_1 + t_1),  *(z_2 + t_2)$ are in $\T$ (\emph{dereferencing}).
\end{enumerate}

\subsection{Quantitative union-find}\label{subsection:quantitative-union-find}

We can represent the quantitative equivalence relation $\equivp$ by using a data structure similar to union-find, but extended with integer offsets.
The \emph{quantitative union-find} $(\T, \tau, \omega)$ consists of a set of terms $\T$,
a function $\tau : \T \rightarrow \T$ that assigns a representative term to each term $t \in \T$ and a mapping $\omega : \T \rightarrow \Z$,
which assigns to each term its offset from the representative of its equivalence class.
This mean that for each $t \in \T$, it holds that $t \equivp \omega\,t + \tau\,t$.
All terms that have the same representative belong to the same equivalence class, i.e., they are equivalent up to an integer offset.
A representative term is a term $t \in \T$ that occurs on the right-hand side of the function $\tau$,
i.e., there exists a $t'\in \T$ such that $\tau\,t' = t$.
For each representative term $t$, it holds that $\tau\,t=t$ and $\omega\,t = 0$.

\subsubsection{Implementation}

The Union-Find data structure can be represented as a forest of trees,
where each tree represents an equivalence class.
Each node in the tree corresponds to a term $t \in \T$, and each tree is rooted at a representative element $\tau\,t$,
which serves as the identifier for the entire set.\cite{uf-tarjan}
All the edges in the tree are directed towards the root.
In order to represent the integer offset, we store a weight for each edge.

The forest is represented as a map $parent : \T \rightarrow \Z \times \T$ that maps each
term $t$ to its parent node in the tree.
The nodes that have themselves as a parent are the representative terms.
If $parent(t_1) = (z,t_2)$, then there is an edge from $t_1$ to $t_2$ with weight $z$
in the graph and it holds that $t_1 \equivp z + t_2$.

The $\find(t)$ operation returns the pair $(\omega\,t,\tau\,t)$.
The offset $\omega t$ can be computed by following the path from $t$ to the root of the tree and summing up the weights of the edges.
The representative $\tau\,t$ is the root of the tree.

Initially, each term $t\in\T$ is its own parent, and equalities $t_1 = z + t_2$ between terms can be added by performing the
$\union{t_1}{z}{t_2}$ operation.
This operation merges two trees by adding an edge from $\tau\,t_1$ to $\tau\,t_2$ with weight $z - \omega\,t_1 + \omega\,t_2$.

\begin{example}
Consider the conjunction $\Psi \equiv B = 1 + A \land D = 2 + \&x \land A = 3 + \&x$.
The union-find algorithm computes the following tree after having performed the three union operations:

\begin{tikzpicture}[->, node distance=2cm, auto]
    \node (x) {$\&x$};
    \node (A) [below left of=x] {$A$};
    \node (D) [below right of=x] {$D$};
    \node (B) [below=1cm of A] {$B$};

    \path (A) edge node {3} (x);
    \path (B) edge node {1} (A);
    \path (D) edge node {2} (x);
\end{tikzpicture}

From this representation, we can for example derive that $B = 4 + \&x$.
Depending on the choice of the representatives, the tree can look different.
\end{example}

In a practical implementation, the representatives are chosen in such a way that the trees have the lowest possible height,
thus making the $\find{t}$ operation more efficient.
This optimization is called \emph{union by rank} and consists in adding the edge from
the smallest to the biggest equivalence class.
Another possible optimization is to set the parent node of a term to the representative of the tree,
each time the $\find{t}$ operation is traverses the node.
This way, the tree is flattened, which makes the $\find{t}$ operation
more efficient if we call it again for the same term $t$ or a term in the same equivalence class.
This is the so-called \emph{path compression}.~\cite{uf-tarjan}

\subsection{Quantitative finite automaton}\label{subsection:qfa}

The union-find data structure is useful for representing equalities between atoms
with an addition of integer offsets.
The union operation needs to be modified in order to take into account also the dereferencing operation.
For example if $\T = \{A, B, *A, *B\}$ and we perform a union of $A$ and $B$, the
closure rule~\ref{item:dereferencing} tells us, that also the equivalence classes of $*A$ and $*B$ should be merged.
In order to efficiently find the equivalence class corresponding to the dereferenced terms of another equivalence class, we introduce the \emph{quantitative finite automaton} (QFA).

The QFA is defined by a triple $(S, \eta, \delta)$, where $S$ is a finite set of states, where each state represents an equivalence class from $\Pi$, $\eta : (\mathcal{A} \cup \{\&x | x \in \X\} \rightarrow \Z \times S)$ is a partial mapping that provides initial offsets and states for atoms, and $\delta : \Z \rightarrow S \rightarrow \Z \times S$ is the partial transition function.
Intuitively, if $\delta(z_1, s_1) = \delta(z_2, s_2)$, this means that for the representatives
$t_1, t_2$ of the equivalence class of $s_1,s_2$, resepectively, it holds that $*(z_1 + t_1) \equivp z_2 + t_2$.

The QFA is constructed from the partition  $(\Pi, \tau, \omega)$ by defining $M[\Psi,\T] = (S, \eta, \delta)$ where $S = \{s_i | Q_i \in \Pi\}$, $\eta a = (\omega a, s_i)$ if $a \in Q_i$ for some $Q_i \in \Pi$, and $\delta z s_i = (\omega t', s_j)$ if there is a $t' \in Q_j$ with $Q_j \in \Pi$, such that $t' = *(z_1 + t_1)$ with $t_1 \in Q_i$ and $z = z_1 + (\omega t_1)$.

We remark that a transition $\delta z s_i$ could derive not only from a single term $t'$ but also from a second term $*(z_2 + t_2) \in \T$ with $t_2 \in Q_i$ and $z = z_2 + (\omega t_2)$.
Since $t_i \equiv (\omega t_i) + (\tau Q_i)$ for $i = 1,2$, it follows that $t_1 \equiv (z_2 - z_1)+ t_2$. Therefore $*(z_2+t_2)\in Q_j$ with offset $\omega(*(z_2+t_2)) = \omega t'$.
This shows that the result of $\delta z s_i$ is well defined and doesn't depend on which term $t'$ we choose for deriving a transition.
Additionally, $\delta$ is defined only for a finite amount of values, given that each term $*(z + t) \in \T$ defines at most one mapping for $\delta$.

We use $\oT$ to denote the set of \emph{all} terms with variable names from $\X$ and auxiliaries from $\A$.
We can extend the mappings $\eta$,$\delta$ to a partial mapping $M : \oT \rightarrow \Z \times S$ where $M[a] = \eta(a)$ for atoms $a$, and $M[*(z+t_1)] = \delta(z+z_1, s)$ for terms $t_1$ if $M[t_1] = (z_1,s)$.

We define $M[\Psi] = M[\Psi,\T_\Psi]$, where $\T_\Psi$ is the set of terms and subterms occurring in $\Psi$.

We also define the set $\L(M)$ of terms $t \in \oT$ for which $M$ is defined.
For each state $s \in S$ we define the set $\L_M(s)$ of terms $t \in \oT$ for which it holds that $M[t] = (z, s)$ for some $z \in \Z$.

Using the automata, the \emph{closure}$(t_1,t_2,z)$ operation, which is the modified version of the union operation, is defined as follows:

\begin{enumerate}
  \item Case 1: $\tau\,t_1 = \tau\,t_2$. If $\omega\,t_1 = z + \omega\,t_2$ we are done.
  If $\omega\,t_1 \neq z + \omega\,t_2$, then the conjunctioin is unsatisfiable.
  \item Case 2: $\tau\,t_1 \neq \tau\,t_2$. We call $\union{t_1}{t_2}{z}$.
  Now either $t_1$ or $t_2$ has a new representative, so the transitions of the QFA are updated accordingly.
  Let $t$ be the term that has a new representative,
  and let $P = (\Pi, \tau, \omega)$ be the partition before the union operation and $P' = (\Pi', \tau', \omega')$ be the partition after the union operation.
  For each outgoing transition $\delta(z_1, s_1) = \delta(z_2, s_2)$ where $t \in \L(s_1)$,
  we set $\delta'(z_1 - \tau\,t'', s_1) = \delta'(z_2, s_2)$.
  \todo[inline]{Then use merge for the successors.}
  \todo{change $z_2$ in incoming transitions? how deep should I go in the details?}
\end{enumerate}

\todo[inline]{This is the same as congruence closure (cite) but restricted to a unary uninterpreted function symbol $*$ and extended with integer offsets as in (cite Oliveras Nieuwenhuis).}

\begin{theorem}
  % This is Theorem 3 in the other paper
  Assume that $\Psi$ is a satisfiable conjunction of equalities, let $\T$ be a subterm-closed set of terms which contains all terms occuring in $\Psi$.
  The corresponding quantitative partition $(\Pi, \tau,\omega)$ and a corresponding QFA $M = (S, \eta, \delta)$ are constructed by applying the closure operation to all equalities in $\Psi$.
  Then $\T \subseteq \L(M)$ and for every $t_1, t_2 \in \L(M)$ the following statements are equivalent:
  \begin{enumerate}
    \item $M[t_1] = z + M[t_2]$,
    \item $\Psi$ implies $(t_1 = z + t_2)$.
  \end{enumerate}
\end{theorem}

This theorem was proven in~\cite{2pointer} for the case of a one-dimensional memory model.
The proof can easily be adapted for the two-dimensional memory model.

We remark that the only equalities that can be derived from $\Psi$ are derived from $\Psi_=$. We cannot derive equalities from any of the disequalities.

bla bla if they have the same rep they are equal
