\section{Quantitative Congruence Closure}\label{chapter:qcc}

Given a conjunction $\Psi$ of propositions, we want to find all equalities logically implied by $\Psi$.
As infinitely many such equalities exist, we only consider the ones containing terms exclusively from a specific set $\T$.
The set $\T$ must be subterm-closed and contain at least all the terms in $\Psi$.
The equalities implied by $\Psi$ containing terms from $\T$ are described by the quantitative equivalence relation $\equivp$, which is the smallest equivalence relation $\equivp$ satisfying these rules:
\begin{enumerate}[label={[E\arabic*]}, ref={[E\arabic*]}]
  \setcounter{enumi}{-1}
  \item\label{item:persistence} If $t_1 = z+t_2$ occurs in $\Psi$, then $t_1 \equivp z+t_2$;
  \item\label{item:quantitative-reflexivity} $t \equivp 0+t$ for all $t\in\T$ (\emph{quantitative reflexivity});
  \item\label{item:quantitative-symmetry} If $t_1 \equivp z+t_2$, then $t_2 \equivp -z+t_1$ (\emph{quantitative symmetry});
  \item\label{item:quantitative-transitivity} If $t_1 \equivp z_1+t_2$ and $t_2 \equivp z_2 + t_3$,
  then $t_1 \equivp (z_1+z_2)+t_3$ (\emph{quantitative transitivity});
  \item\label{item:dereferencing} If $t_1 \equivp (z_2 - z_1) + t_2$, then $*(z_1 + t_1) \equivp *(z_2 + t_2)$ holds as well, whenever $*(z_1 + t_1), Â *(z_2 + t_2)$ are in $\T$ (\emph{dereferencing}).
\end{enumerate}

\subsection{Quantitative Partition}\label{subsection:quantitative-union-find}

We can represent the quantitative equivalence relation $\equivp$ as a partition.
The \emph{quantitative partition} $P = (\T, \tau, \omega)$ consists of a set of terms $\T$,
a function $\tau : \T \rightarrow \T$ that assigns a \emph{representative} to each term $t \in \T$ and a mapping $\omega : \T \rightarrow \Z$,
which assigns to each term its offset from the representative of its equivalence class.
These two functions model equalities of the form $t \equivp \omega\,t + \tau\,t$ for each $t \in \T$.
All terms with the same representative belong to the same equivalence class, i.e., they are equivalent up to an integer offset.
The set of representative terms $rep(P)$ is the set of terms $t \in \T$ that occur on the right-hand side of the function $\tau$, i.e., there exists a $t'\in \T$ such that $\tau\,t' = t$.
For each $t\in rep(P)$, it holds that $\tau\,t=t$ and $\omega\,t = 0$.

\subsubsection{Implementation}

The quantitative partition is represented using a data structure similar to union-find but extended with integer offsets.
The union-find data structure is represented as a forest of trees, each representing an equivalence class.
Each node in the tree corresponds to a term $t \in \T$, and the roots are representative elements $\tau\,t$.\cite{uf-tarjan}
All the edges in the tree are directed towards the root.
In order to represent the integer offset, each edge is labeled with an integer weight.

The forest is represented as a map $parent : \T \rightarrow \Z \times \T$ that maps each term $t$ to an integer offset and its parent node in the tree.
The nodes that have themselves as a parent are the representative terms.
The mapping $parent(t_1) = (z,t_2)$ defines an edge from $t_1$ to $t_2$ with weight $z$ in the graph, and it implies the equality $t_1 \equivp z + t_2$.

In order to compute the representative of a term in the tree, there is an operation $\find{t}$.
It returns the pair $(\omega\,t,\tau\,t)$.
The offset $\omega t$ can be computed by following the path from $t$ to the tree's root and summing up the weights of the encountered edges.
The representative $\tau\,t$ is the root of the tree containing $t$.

The union-find tree is built incrementally by adding consecutively equalities.
Initially, each term $t\in\T$ is its own parent, and equalities $t_1 = z + t_2$ between terms can be added by performing the $\union{t_1}{z}{t_2}$ operation.
This operation merges two trees by adding an edge from $\tau\,t_1$ to $\tau\,t_2$ with weight $z - \omega\,t_1 + \omega\,t_2$,
thus merging the two equivalence classes of $t_1$ and $t_2$ with the correct offset.
If the two terms are already equivalent with a different offset, i.e., $\tau\,t_1 = \tau\,t_2$, but $z - \omega\,t_1 + \omega\,t_2 \neq 0$, then the conjunction is unsatisfiable.

\begin{example}
  Consider the conjunction $\Psi \equiv (B = 1 + A) \land (D = 2 + \&x) \land (A = 3 + \&x)$.
  The tree computed by the union-find algorithm is illustrated in \cref{fig:uf-tree}.
  \begin{figure}
    \begin{tikzpicture}[->, node distance=2cm, auto]
      \node (x) {$\&x$};
      \node (A) [below left of=x] {$A$};
      \node (D) [below right of=x] {$D$};
      \node (B) [below=1cm of A] {$B$};

      \path (A) edge node {3} (x);
      \path (B) edge node {1} (A);
      \path (D) edge node {2} (x);
    \end{tikzpicture}
    \caption{Union-find tree corresponding to the conjunction  $(B = 1 + A) \land (D = 2 + \&x) \land (A = 3 + \&x)$}\label{fig:uf-tree}
  \end{figure}
  From this representation, we can, for example, derive that $B = 4 + \&x$.
  The tree can look different depending on the choice of the representatives.
\end{example}

In a practical implementation, the representatives are chosen such that the trees have the lowest possible height, thus making the $\find{t}$ operation more efficient.
This optimization is called \emph{union by rank} and consists of adding the edge from the smallest to the largest equivalence class during the $\union{t_1}{t_2}$ operation.
Another possible optimization is, during the $\find{t}$ operation, to set the parent node of a term to the representative of the tree each time a node is traversed.
This way, the tree is flattened, which makes the $\find{t}$ operation
more efficient if we call it again for the same term $t$ or a term in the same equivalence class.
This is the so-called \emph{path compression}.~\cite{uf-tarjan}
%-----------
\subsection{Quantitative finite automaton}\label{subsection:qfa}

A partition $P = (\T, \tau, \omega)$ is useful for representing equalities between atoms
with an addition of integer offsets and it computes the closure under the rules
\labelcref{item:persistence,item:quantitative-reflexivity,item:quantitative-symmetry,item:quantitative-transitivity}
by construction.
In order to take into account the dereferencing operation, we need to
keep track for each term $t$, which equivalence classes contain terms of the form $*(z+t)$.
This way, we can efficiently compute the equalities deriving from rule \labelcref{item:dereferencing}.
For example if $\T = \{A, B, *A, *B\}$ and we perform a union of $A$ and $B$, the
closure rule~\labelcref{item:dereferencing} tells us, that also the equivalence classes of $*A$ and $*B$ should be merged.
Therefore, we introduce an alternative representation of the partition $P$ as a \emph{quantitative finite automaton} (QFA) $M_P$.

The QFA is defined by a triple $M_P = (S, \otau, \eta, \delta)$, where $S$ is a finite set of states, where each state represents an equivalence class of the partition.
In order to know which state represents which equivalence class, the mapping $\otau : S \rightarrow \T$
assigns a representative term to each state.
The partial mapping $\eta : (\mathcal{A} \cup \{\&x | x \in \X\} \rightarrow \Z \times S)$ provides initial offsets and states for atoms, meaning that if $\eta\,a = (z,s)$, then $a$ is in the equivalence class represented by $s$.
$\delta : \Z \rightarrow S \rightarrow \Z \times S$ is the partial transition function.
Intuitively, if $\delta\,z_1\,s_1 = (z_2, s_2)$, this means that it holds that $*(z_1 + \otau\,s_1) \equivp z_2 + \otau\,s_2$.

The QFA is constructed from the partition  $(\T, \tau, \omega)$ by defining $M_P = (S, \otau, \eta, \delta)$ where $S$ contains a state $s$ for each representative term $t$ of $P$ and we set $\otau\,s = t$.
$\eta\,a = (\omega\,a, s_1)$ if $s_1 \in S$ and $\otau\,s = \tau\,a$,
and $\delta\,z\,s_1 = (\omega\,t', s_2)$ if there is a $\tau\,t'=\otau\,s_2$, such that $t' \equiv *(z_1 + t_1)$ with $\tau \,t_1= \otau\,s_1$ and $z = z_1 + \omega\,t_1$.

We remark that a transition $\delta\,z\,s_1$ could derive not only from a single term $t'$ but also from a second term $*(z_2 + t_2) \in \T$ with $\tau\,t_2=\otau\,s_1$ and $z = z_2 + \omega\,t_2$.
Since $t_i \equivp (\omega t_i) + (\tau Q_i)$ for $i = 1,2$, it follows that $t_1 \equivp (z_2 - z_1)+ t_2$.
Therefore $\tau\,*(z_2+t_2)=\otau\,s_2$ with offset $\omega(*(z_2+t_2)) = \omega\,t'$.
This shows that the result of $\delta\,z\,s_1$ is well defined and doesn't depend on which term $t'$ we choose for deriving a transition.
Additionally, $\delta$ is defined only for a finite amount of values, given that each term $*(z + t) \in \T$ defines at most one mapping for $\delta$.

We use $\oT$ to denote the set of \emph{all} terms with variable names from $\X$ and auxiliaries from $\A$.
We can extend the mappings $\eta$ and $\delta$ to a partial mapping $M : \oT \rightarrow \Z \times S$ where $M_P[a] = \eta(a)$ for atoms $a$, and $M_P[*(z+t_1)] = \delta(z+z_1, s)$ for terms $t_1$ if $M_P[t_1] = (z_1,s)$.

Additionally, we define the set $\L(M_P)$ of terms $t \in \oT$ for which $M$ is defined.
For each state $s \in S$, the set $\L_M(s)$ is the set of terms $t \in \oT$ for which it holds that $M_P[t] = (z, s)$ for some $z \in \Z$.

Using the automata, the $\closure{t_1}{z}{t_2}$\todo{add result type and $P$ and $M_P$ to the parameters}  operation performs the union of $t_1$ and $t_2$ and
then computes the closure using the rule \labelcref{item:dereferencing}.
It is defined as follows:

\begin{enumerate}
  \item Case 1: $\tau\,t_1 = \tau\,t_2$. If $\omega\,t_1 = z + \omega\,t_2$ we are done.
        If $\omega\,t_1 \neq z + \omega\,t_2$, then the conjunction is unsatisfiable.
  \item Case 2: $\tau\,t_1 \neq \tau\,t_2$. We call $\union{t_1}{t_2}{z}$.
        Now either $t_1$ or $t_2$ has a new representative, so the transitions of the QFA are updated accordingly.
        Let $t$ be the term between $t_1$ and $t_2$ that has a new representative,
        and let $P = (\T, \tau, \omega)$ and $M_P = (S, \otau, \eta, \delta)$ be the partition and qutomaton before the union operation
        and $P' = (\T, \tau', \omega')$ and $M_{P'} = (S', \otau', \eta', \delta')$ be the partition after the union operation.
        For each outgoing transition $\delta(z_1, s_1) = \delta(z_2, s_2)$ where $t \in \L_{M_P}(s_1)$,
        we set $\delta'(z_1 - \omega\,(\tau\,t), s_1) = \delta'(z_2, s_2)$.
        \todo[inline]{Then use merge for the successors.}
        \todo{change $z_2$ in incoming transitions? how deep should I go in the details?}
\end{enumerate}

\todo[inline]{This is the same as congruence closure (cite) but restricted to a unary uninterpreted function symbol $*$ and extended with integer offsets as in (cite Oliveras Nieuwenhuis).}

\todo[inline]{Define visualization, each equivalence class has one state and
  terms represetned are only those in $\T$, while there are more terms in $\L_{M_P}(s)$}

\begin{theorem}
  % This is Theorem 3 in the other paper
  Assume that $\Psi$ is a satisfiable conjunction of equalities, let $\T$ be a subterm-closed set of terms which contains all terms occuring in $\Psi$.
  The corresponding quantitative partition $(\T, \tau,\omega)$ and a corresponding QFA $M_P = (S, \otau, \eta, \delta)$ are constructed by applying the closure operation with all equalities in $\Psi$.
  Then $\T \subseteq \L(M_P)$ and for every $t_1, t_2 \in \L(M_P)$ the following statements are equivalent:
  \begin{enumerate}
    \item $M_P[t_1] = z + M_P[t_2]$,
    \item $\tau\,t_1 = \tau\,t_2$ and $\omega\,t_1 = z + \omega\,t_2$,
    \item $\Psi$ implies $(t_1 = z + t_2)$.
  \end{enumerate}
\end{theorem}

This theorem was proven in~\cite{2pointer} for the case of a one-dimensional memory model.
The proof can easily be adapted for the two-dimensional memory model.

We remark that the only equalities that can be derived from $\Psi$ are derived from $\Psi_=$. We cannot derive equalities from any of the disequalities.
