\chapter{2-Pointer Logic as an Abstract Domain}\label{chapter:2pointer}

The abstract domain of the \cpo\ analysis consists of finite conjunctions of propositions from the 2-Pointer Logic.
In the following section, we describe this logic and how to represent the propositions to infer all deriving propositions.
Then, we discuss the extension of the domain to include additional terms and the restriction of the domain to a subset of terms, which will be needed later for the analysis.

\todo{
  Move somewhere:
}

It is possible to define an order on terms, given a linear order $<$ on atoms, by defining:
\begin{itemize}
  \item $a < *(z+t)$ whenever $a$ is an atom and
  \item $*(z_1 + t_1) < *(z_2 + t_2)$ whenever either $t_1 < t_2$ or $t_1 \equiv t_2$ and $z_1 < z_2$.
\end{itemize}

\textcite{2pointer} introduced the 2-Pointer Logic, which consists of equalities and disequalities between the terms described in \cref{chapter:concrete_semantics}.
Here, we extend this logic with an additional type of proposition, the \emph{block disequalities}.
These disequalities express that two terms do not belong to the same address block.
The propositions $p$ are defined by the following grammar:
\[
  p\,{::=}\,t_1=z+t_2 \mid t_1\neq z+t_2\mid bl(t_1) \neq bl(t_2),
\]
where $*$ denotes the dereferencing operator and $bl(t)$ represents the address block of $t$.
We use $*t$ as an abbreviation for $*(0+t)$ and $x$ as an abbreviation for $*(0+\&x)$.

Moreover, we define the function $bl : \ZZ \rightarrow \Z$ that returns the address block identifier of an address, where $bl(a,b) = a$.
The validity of a proposition under a concrete state $(\rho,\nu,\mu)$ is defined as:
\[
  \begin{array}{ll}
    (\rho,\nu,\mu)\models t_1 = z+t_2          & \textbf{iff}
    \\ \multicolumn{2}{c}{\quad\quad\quad\quad\sem{t_1}\,(\rho,\nu,\mu) = z+\sem{t_2}\,(\rho,\nu,\mu)} Â \\
    (\rho,\nu,\mu)\models t_1 \neq z+t_2       & \textbf{iff}
    \\ \multicolumn{2}{c}{\quad\quad\quad\quad\sem{t_1}\,(\rho,\nu,\mu) \neq z+\sem{t_2}\,(\rho,\nu,\mu)} \\
    (\rho,\nu,\mu)\models bl(t_1) \neq bl(t_2) & \textbf{iff}
    \\ \multicolumn{2}{c}{\quad\quad\quad\quad bl(\sem{t_1}\,(\rho, \nu, \mu)) \neq bl(\sem{t_2}\,(\rho, \nu, \mu))}
  \end{array}
\]

If $(\rho, \nu, \mu)\models p$ for each proposition $p$ in $\Psi$, then we say that $(\rho, \nu, \mu) \models \Psi$.
\todo[inline]{The domain is not this anymore, it's the kernels. Move this.

The domain of 2-Pointer Logic $\mathcal{P}_2[=]$ consists of all finite conjunctions
of propositions over terms up to semantic equivalence.
The concretization $\gamma(\Psi)$ of $\Psi$ is the set of all $(\rho, \nu, \mu)$ with $(\rho, \nu, \mu) \models \Psi$.
}

\input{content/representation}
\input{content/qcc}
\input{content/diseqs}

\section{Kernel Representation of 2-Pointer Logic Conjunctions}
The abstract values of the \cpo\ analysis consist of a representation
of 2-Pointer Logic conjunctions, as detailed in the previous chapter.
This ensures that whenever propositions are added to or removed from the domain,
the closure of all implied propositions is computed.

The representation consists of a tuple $k = \angl{P,M_P,B,D}$,
where $P = (\T, \tau, \omega)$ is a quantitative partition, as described in \cref{subsection:quantitative-union-find}.
Each state of the QFA $M$ represents an equivalence class of $P$, as outlined in \cref{subsection:qfa}.
$B$ and $D$ are lists of explicit block disequalities and disequalities, respectively, as detailed in \cref{section:block-disequalities,section:disequalities}.

The tuple $k$ is called the \emph{kernel} representation of $\Psi$.
For an unsatisfiable formula $\Psi$, the kernel representation is $\bot$.

It is posible to convert a kernel representation $k = \angl{P,M_P,B,D} \neq \bot$ with $M_P = (S, \otau, \eta, \delta)$ to a formula $\F[k]$, that is given by

\[
  \begin{array}{lll}
    \F[k] & \equiv & \bigwedge_{\eta\,a=(z,s)} (a = z + \otau\,s) \land                        \\
          &        & \bigwedge_{\delta\,z\,s=(z',s')} (*(z + \otau\,s) = z' + \otau\,s') \land \\
          &        & \bigwedge_{\{t, t'\} \in B} (bl(t) \neq bl(t')) \land                     \\
          &        & \bigwedge_{(t, z, t') \in D} (t \neq z + t')
  \end{array}
\]

The trivial propositions of the form $t = 0 + t$ are removed from the formula, as well as the repeated equalities.

If $k$ is the kernel of a conjunction $\Psi$, then $\F[k]$ is equivalent to $\Psi$,
even though it may not be syntactically identical.
They could be syntactically different because of a different choice of representative terms.
\todo[inline]{say something about abstraction and concretization}

\input{content/insert_terms}
\input{content/restriction}
